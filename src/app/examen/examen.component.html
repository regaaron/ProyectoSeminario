<div class="background-grid">
  <!-- Overlay de carga -->
  <div class="loading-overlay" *ngIf="isCargando">
    <div class="spinner"></div>
    <div class="loading-text">
      {{ iaActual ? 'Generando preguntas con IA, por favor espera…' : 'Cargando preguntas…' }}
    </div>
  </div>
  <div class="examen-container" *ngIf="!isFinalizado && examen.length > 0">

    <!-- Forzar recreación con *ngFor y trackBy -->
    <div *ngFor="let pregunta of [examen[currentQuestionIndex]]; trackBy: trackByPregunta" [@fadeSlide]>

      <div class="pregunta-header">
        <h2 class="pregunta-titulo">
          {{ currentQuestionIndex + 1 }}. {{ pregunta.pregunta_enunciado }}
        </h2>
        <span class="seleccion-tipo">Selección única</span>
      </div>

      <!-- Feedback correcta/incorrecta -->
      <div class="feedback" *ngIf="showFeedback" [class.ok]="feedbackCorrecta" [class.error]="!feedbackCorrecta">
        <div>{{ feedbackCorrecta ? '¡Respuesta correcta!' : 'Respuesta incorrecta' }}</div>
        <div *ngIf="!feedbackCorrecta && feedbackRespuestaCorrectaTexto">
          La correcta era: <strong>{{ feedbackRespuestaCorrectaTexto }}</strong>
        </div>
      </div>

      <div class="respuestas-grid">
        <div *ngFor="let respuesta of pregunta.respuestas"
             class="respuesta-opcion-card"
             [ngClass]="{
               'seleccionada': isRespuestaSeleccionada(pregunta.id_pregunta, respuesta.id_respuesta),
               'correcta': showFeedback && esRespuestaCorrecta(pregunta, respuesta) && isRespuestaSeleccionada(pregunta.id_pregunta, respuesta.id_respuesta),
               'incorrecta': showFeedback && !esRespuestaCorrecta(pregunta, respuesta) && isRespuestaSeleccionada(pregunta.id_pregunta, respuesta.id_respuesta),
               'verdadera': showFeedback && esRespuestaCorrecta(pregunta, respuesta) && !isRespuestaSeleccionada(pregunta.id_pregunta, respuesta.id_respuesta)
             }"
             (click)="seleccionarRespuesta(pregunta.id_pregunta, respuesta.id_respuesta, pregunta, respuesta)">

          <input type="radio"
                 [id]="'r' + respuesta.id_respuesta"
                 [name]="'pregunta' + pregunta.id_pregunta"
                 class="respuesta-radio"
                 [checked]="isRespuestaSeleccionada(pregunta.id_pregunta, respuesta.id_respuesta)">

          <label [for]="'r' + respuesta.id_respuesta" class="respuesta-label">
            {{ respuesta.respuesta_texto }}
          </label>
        </div>
      </div>

    </div> <!-- Fin del fadeSlide -->

    <!-- Footer navegación -->
    <div class="footer-navegacion">
      <div class="progreso">
        Progreso
        <span class="progreso-texto">{{ answeredQuestionsCount }} de {{ examen.length }} respondidas</span>
      </div>

      <button class="btn-navegacion siguiente"
              [disabled]="!isPreguntaRespondida(examen[currentQuestionIndex]?.id_pregunta)"
              (click)="onNext()">
              {{ isLastQuestion() ? 'Finalizar' : 'Siguiente' }}
      </button>
    </div>

  </div>

  <!-- Resultados del examen -->
  <div class="examen-container" *ngIf="isFinalizado">
    <div class="pregunta-header">
      <h2 class="pregunta-titulo">Resultados</h2>
      <span class="seleccion-tipo">Resumen</span>
    </div>
    <div class="resultados">
      <p>Total de preguntas: <strong>{{ examen.length }}</strong></p>
      <p>Correctas: <strong>{{ resultadoCorrectas }}</strong></p>
      <p>Puntaje: <strong>{{ resultadoPuntaje }}%</strong></p>
    </div>
    <div class="footer-navegacion">
      <button class="btn-navegacion siguiente" (click)="regenerarExamen()">Volver a generar otro examen</button>
    </div>
  </div>
</div>
